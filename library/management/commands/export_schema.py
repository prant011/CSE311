from django.core.management.base import BaseCommand
from django.db import connection
from django.apps import apps
import os

class Command(BaseCommand):
    help = 'Export database schema to SQL file'

    def add_arguments(self, parser):
        parser.add_argument(
            '--output',
            type=str,
            default='database/library_management_schema.sql',
            help='Output file path',
        )

    def handle(self, *args, **options):
        output_file = options['output']

        # Ensure the database directory exists
        os.makedirs(os.path.dirname(output_file), exist_ok=True)

        self.stdout.write(f'Exporting database schema to {output_file}...')

        with connection.cursor() as cursor:
            # Get all table names
            cursor.execute("SHOW TABLES;")
            tables = cursor.fetchall()

            with open(output_file, 'w', encoding='utf-8') as f:
                # Write header
                f.write('-- Library Management System Database Schema\n')
                f.write('-- Auto-generated by Django management command\n')
                f.write('-- \n')
                f.write(f'-- Generated on: {self.get_current_timestamp()}\n')
                f.write('-- \n\n')

                # Export each table structure
                for table_row in tables:
                    table_name = table_row[0]
                    self.export_table_schema(cursor, table_name, f)

        self.stdout.write(
            self.style.SUCCESS(f'Successfully exported database schema to {output_file}')
        )

    def get_current_timestamp(self):
        from django.utils import timezone
        return timezone.now().strftime('%Y-%m-%d %H:%M:%S')

    def export_table_schema(self, cursor, table_name, file_handle):
        """Export CREATE TABLE statement for a table"""
        # Get CREATE TABLE statement
        cursor.execute(f"SHOW CREATE TABLE `{table_name}`;")
        create_table_result = cursor.fetchone()

        if create_table_result:
            create_statement = create_table_result[1]

            file_handle.write(f'-- Table: {table_name}\n')
            file_handle.write(f'{create_statement};\n\n')

            # Get indexes
            cursor.execute(f"SHOW INDEX FROM `{table_name}`;")
            indexes = cursor.fetchall()

            if indexes:
                file_handle.write(f'-- Indexes for {table_name}\n')
                current_index = None
                index_columns = []

                for index in indexes:
                    index_name = index[2]  # Key_name
                    column_name = index[4]  # Column_name
                    non_unique = index[1]  # Non_unique

                    if index_name != current_index:
                        if current_index is not None:
                            # Write previous index
                            self.write_index(file_handle, table_name, current_index, index_columns, non_unique == 0)

                        current_index = index_name
                        index_columns = [column_name]
                    else:
                        index_columns.append(column_name)

                # Write last index
                if current_index:
                    self.write_index(file_handle, table_name, current_index, index_columns, non_unique == 0)

                file_handle.write('\n')

    def write_index(self, file_handle, table_name, index_name, columns, is_unique):
        """Write index creation statement"""
        if index_name == 'PRIMARY':
            return  # Primary key is already in CREATE TABLE

        columns_str = ', '.join(f'`{col}`' for col in columns)

        if is_unique:
            file_handle.write(f'ALTER TABLE `{table_name}` ADD UNIQUE KEY `{index_name}` ({columns_str});\n')
        else:
            file_handle.write(f'ALTER TABLE `{table_name}` ADD KEY `{index_name}` ({columns_str});\n')
